import time
import allure
from selenium.webdriver.common.by import By
from pages.base_page import BasePage


class CardPage(BasePage):
    """
    Класс Page Object для страницы добавления товара в корзину.
    Этот класс описывает логику действий пользователя:
    - выбор товара на главной странице,
    - добавление его в корзину,
    - переход в корзину,
    - проверку, что товар успешно добавлен.
    """

    def add_to_card(self):
        """
        Добавляет товар в корзину и проверяет, что он появился в корзине.

        Последовательность шагов:
        1. Находит элемент товара (название) на странице.
        2. Запоминает текст этого товара.
        3. Нажимает на кнопку "В корзину".
        4. Переходит на страницу корзины.
        5. Сравнивает название добавленного товара с названием товара в корзине.
        """

        # Локатор кнопки "В корзину" (берём второй элемент на странице)
        btn_add_to_card = '(// span[text() = " В корзину"])[2]'

        # Локатор кнопки перехода в корзину (иконка корзины в шапке)
        btn_go_to_cart = "desktop-header-go-to-cart-link"

        # Сохраняем название товара, чтобы потом сверить с корзиной
        item_added_to_cart = self.get_text(
            By.XPATH,
            '(//p[@class="max-w-xs text-sm text-grey-900 line-clamp-2 text-ellipsis mb-1 !text-xs"])[2]'
        )

        # ---------- Шаг 1 ----------
        with allure.step("Добавляем товар в корзину"):
            # Нажимаем кнопку "В корзину" для выбранного товара
            self.click(value=btn_add_to_card, by=By.XPATH)
            # Делаем паузу для корректной загрузки интерфейса
            time.sleep(3)

        # ---------- Шаг 2 ----------
        with allure.step("Переходим на страницу корзины"):
            # Кликаем на иконку корзины в шапке
            self.click(value=btn_go_to_cart, by=By.ID)
            # Ждём загрузку страницы корзины
            time.sleep(3)

        # ---------- Шаг 3 ----------
        with allure.step("Сравнение названия добавленного товара с товаром в корзине"):
            # Ищем название товара в корзине и сохраняем
            item_in_cart = self.get_text(
                By.XPATH,
                '//h2[@class="text-sm font-medium mb-1"]'
            )

            # Сравниваем название добавленного товара с тем, что в корзине
            assert item_added_to_cart == item_in_cart, (
                f"Ожидали заголовок '{item_added_to_cart}', "
                f"но получили '{item_in_cart}'"
            )

        # Небольшая задержка для корректного завершения шага
        time.sleep(3)
